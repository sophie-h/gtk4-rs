<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Saving Window State - GUI development with Rust and GTK 4</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="prerequisites.html"><strong aria-hidden="true">1.</strong> Prerequisites</a></li><li class="chapter-item expanded "><a href="hello_world.html"><strong aria-hidden="true">2.</strong> Hello World!</a></li><li class="chapter-item expanded "><a href="widgets.html"><strong aria-hidden="true">3.</strong> Widgets</a></li><li class="chapter-item expanded "><a href="gobject_concepts.html"><strong aria-hidden="true">4.</strong> GObject Concepts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="gobject_memory_management.html"><strong aria-hidden="true">4.1.</strong> Memory Management</a></li><li class="chapter-item expanded "><a href="gobject_subclassing.html"><strong aria-hidden="true">4.2.</strong> Subclassing</a></li><li class="chapter-item expanded "><a href="gobject_values.html"><strong aria-hidden="true">4.3.</strong> Generic Values</a></li><li class="chapter-item expanded "><a href="gobject_properties.html"><strong aria-hidden="true">4.4.</strong> Properties</a></li><li class="chapter-item expanded "><a href="gobject_signals.html"><strong aria-hidden="true">4.5.</strong> Signals</a></li></ol></li><li class="chapter-item expanded "><a href="main_event_loop.html"><strong aria-hidden="true">5.</strong> The Main Event Loop</a></li><li class="chapter-item expanded "><a href="settings.html"><strong aria-hidden="true">6.</strong> Settings</a></li><li class="chapter-item expanded "><a href="saving_window_state.html" class="active"><strong aria-hidden="true">7.</strong> Saving Window State</a></li><li class="chapter-item expanded "><a href="lists.html"><strong aria-hidden="true">8.</strong> Lists</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">9.</strong> Building a Simple To-Do App</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.</strong> Interface Builder</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">10.1.</strong> GtkBuilder</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">10.2.</strong> Templates</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">11.</strong> Resources</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.</strong> Actions</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.</strong> Shortcuts</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">14.</strong> Media Support</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">14.1.</strong> Images</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">14.2.</strong> Videos</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">15.</strong> App with Persistent Image Selection</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">16.</strong> Accessibility</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">17.</strong> Internationalization</div></li><li class="chapter-item expanded affix "><li class="part-title">Useful Libraries</li><li class="chapter-item expanded "><div><strong aria-hidden="true">18.</strong> GtkSourceView</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">19.</strong> GStreamer</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">20.</strong> Libadwaita</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">21.</strong> Webkit2Gtk</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">22.</strong> Zbus and Ashpd</div></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">GUI development with Rust and GTK 4</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/gtk-rs/gtk4-rs/tree/master/book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                        

                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="saving-window-state"><a class="header" href="#saving-window-state">Saving Window State</a></h1>
<p>Quite often, we want the window state to persist between sessions.
If the user resizes or maximizes the window, they might expect to find it in the same state the next time they open the app.
GTK does not provide this functionality out of the box, but luckily it is not too hard to manually implement it.
We basically want two integers (<code>height</code> &amp; <code>width</code>) and a boolean (<code>is_maximized</code>) to persist.
We already know how to do this by using <code>Settings</code>.</p>
<p><span class="filename">Filename: listings/saving_window_state/1/org.gtk.example.gschema.xml</span></p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;schemalist&gt;
  &lt;schema id=&quot;org.gtk.example&quot; path=&quot;/org/gtk/example/&quot;&gt;
    &lt;key name=&quot;window-width&quot; type=&quot;i&quot;&gt;
      &lt;default&gt;-1&lt;/default&gt;
      &lt;summary&gt;Default window width&lt;/summary&gt;
    &lt;/key&gt;
    &lt;key name=&quot;window-height&quot; type=&quot;i&quot;&gt;
      &lt;default&gt;-1&lt;/default&gt;
      &lt;summary&gt;Default window height&lt;/summary&gt;
    &lt;/key&gt;
    &lt;key name=&quot;is-maximized&quot; type=&quot;b&quot;&gt;
      &lt;default&gt;false&lt;/default&gt;
      &lt;summary&gt;Default window maximized behaviour&lt;/summary&gt;
    &lt;/key&gt;
  &lt;/schema&gt;
&lt;/schemalist&gt;
</code></pre>
<p>Since we do not care about intermediate state, we only load the window state when the window is constructed and save it when we close the window.
That can be done by creating a custom window.
First, we create one and add methods for getting and setting the window state.</p>
<p><span class="filename">Filename: listings/saving_window_state/1/custom_window/mod.rs</span></p>
<pre><pre class="playground"><code class="language-rust no_run"><span class="boring">mod imp;
</span><span class="boring">
</span><span class="boring">use glib::Object;
</span><span class="boring">use gtk::prelude::*;
</span><span class="boring">use gtk::subclass::prelude::*;
</span><span class="boring">use gtk::Application;
</span><span class="boring">use gtk::{gio, glib};
</span><span class="boring">
</span>glib::wrapper! {
    pub struct CustomWindow(ObjectSubclass&lt;imp::CustomWindow&gt;)
        @extends gtk::Widget, gtk::Window, gtk::ApplicationWindow,
        @implements gio::ActionMap, gio::ActionGroup;
}

impl CustomWindow {
    pub fn new(app: &amp;Application) -&gt; Self {
        let window: Self = Object::new(&amp;[]).expect(&quot;Failed to create CustomWindow&quot;);
        window.set_application(Some(app));
        window
    }

    pub fn save_window_size(&amp;self) -&gt; Result&lt;(), glib::BoolError&gt; {
        // Get `settings` from `imp::CustomWindow`
        let settings = &amp;imp::CustomWindow::from_instance(self).settings;

        // Get the size of the window
        let size = self.default_size();

        // Get the window state from `settings`
        settings.set_int(&quot;window-width&quot;, size.0)?;
        settings.set_int(&quot;window-height&quot;, size.1)?;
        settings.set_boolean(&quot;is-maximized&quot;, self.is_maximized())?;

        Ok(())
    }

    fn load_window_size(&amp;self) {
        // Get `settings` from `imp::CustomWindow`
        let settings = &amp;imp::CustomWindow::from_instance(self).settings;

        // Set the window state in `settings`
        let width = settings.int(&quot;window-width&quot;);
        let height = settings.int(&quot;window-height&quot;);
        let is_maximized = settings.boolean(&quot;is-maximized&quot;);

        // Set the size of the window
        self.set_default_size(width, height);

        // If the window was maximized when it was closed, maximize it again
        if is_maximized {
            self.maximize();
        }
    }
}

<span class="boring">// Please ignore this line
</span><span class="boring">// It is only there to make mdbook happy
</span><span class="boring">fn main() {}
</span></code></pre></pre>
<p>The implementation struct holds the <code>settings</code>.
We also overload the <code>constructed</code> and <code>close_request</code> methods, where we load or save the window state. </p>
<p><span class="filename">Filename: listings/saving_window_state/1/custom_window/imp.rs</span></p>
<pre><pre class="playground"><code class="language-rust no_run"><span class="boring">use gio::Settings;
</span><span class="boring">use glib::signal::Inhibit;
</span><span class="boring">use gtk::{gio, glib};
</span><span class="boring">use gtk::{subclass::prelude::*, ApplicationWindow};
</span><span class="boring">
</span>pub struct CustomWindow {
    pub settings: Settings,
}

#[glib::object_subclass]
impl ObjectSubclass for CustomWindow {
    const NAME: &amp;'static str = &quot;CustomWindow&quot;;
    type Type = super::CustomWindow;
    type ParentType = ApplicationWindow;

    fn new() -&gt; Self {
        Self {
            settings: Settings::new(&quot;org.gtk.example&quot;),
        }
    }
}
impl ObjectImpl for CustomWindow {
    fn constructed(&amp;self, obj: &amp;Self::Type) {
        self.parent_constructed(obj);
        // Load latest window state
        obj.load_window_size();
    }
}
impl WidgetImpl for CustomWindow {}
impl WindowImpl for CustomWindow {
    // Save window state right before the window will be closed
    fn close_request(&amp;self, obj: &amp;Self::Type) -&gt; Inhibit {
        if let Err(err) = obj.save_window_size() {
            log::error!(&quot;Failed to save window state, {}&quot;, &amp;err);
        }
        // Do not inhibit the the default handler
        Inhibit(false)
    }
}
impl ApplicationWindowImpl for CustomWindow {}

<span class="boring">// Please ignore this line
</span><span class="boring">// It is only there to make mdbook happy
</span><span class="boring">fn main() {}
</span></code></pre></pre>
<p>That is it!
Now our window retains its state between app sessions.</p>
<p>Please note how we handle a failure in saving into the settings.
We do not want to panic for recoverable errors.
We might also not want to present all problems at the GUI.
In our case we could not even do this, because the window will be immediately closed after the error occurs.
Logging is the standard way of handling a situation like this.
For that, we need to add the <code>log</code> crate and one of its front-ends, such as <code>pretty_env_logger</code>, to our dependencies.</p>
<p><span class="filename">Filename: listings/Cargo.toml</span></p>
<pre><code class="language-toml">[dependencies]
log = &quot;0.4&quot;
pretty_env_logger = &quot;0.4&quot;
</code></pre>
<p>We then have to initialize <code>pretty_env_logger</code> by calling <code>init</code> in <code>main</code>.</p>
<p><span class="filename">Filename: listings/saving_window_state/1/main.rs</span></p>
<pre><pre class="playground"><code class="language-rust no_run"><span class="boring">mod custom_window;
</span><span class="boring">
</span><span class="boring">use custom_window::CustomWindow;
</span><span class="boring">use gtk::prelude::*;
</span><span class="boring">use gtk::{Application, Button};
</span><span class="boring">
</span>fn main() {
    // Initialize logger
    pretty_env_logger::init();

    // Create a new application
    let app = Application::new(Some(&quot;org.gtk.example&quot;), Default::default());
    app.connect_activate(build_ui);

    // Run the application
    app.run();
}
<span class="boring">
</span><span class="boring">fn build_ui(application: &amp;Application) {
</span><span class="boring">    // Create a window
</span><span class="boring">    let window = CustomWindow::new(application);
</span><span class="boring">
</span><span class="boring">    // Create a button
</span><span class="boring">    let button = Button::builder()
</span><span class="boring">        .label(&quot;Press me!&quot;)
</span><span class="boring">        .margin_top(12)
</span><span class="boring">        .margin_bottom(12)
</span><span class="boring">        .margin_start(12)
</span><span class="boring">        .margin_end(12)
</span><span class="boring">        .build();
</span><span class="boring">
</span><span class="boring">    // Connect callback
</span><span class="boring">    button.connect_clicked(move |button| {
</span><span class="boring">        // Set the label to &quot;Hello World!&quot; after the button has been clicked on
</span><span class="boring">        button.set_label(&quot;Hello World!&quot;);
</span><span class="boring">    });
</span><span class="boring">
</span><span class="boring">    // Add button
</span><span class="boring">    window.set_child(Some(&amp;button));
</span><span class="boring">    window.present();
</span><span class="boring">}
</span></code></pre></pre>
<p>We can now modify the log level by setting the <code>RUST_LOG</code> environment variable as can be seen <a href="https://docs.rs/env_logger/latest/env_logger/">here</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="settings.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="lists.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="settings.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="lists.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
